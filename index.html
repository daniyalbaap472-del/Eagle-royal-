<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live TV - Watch Free Streaming</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Icons & Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            color: white;
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .channel-card {
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .channel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border-color: rgba(59, 130, 246, 0.5);
        }
        
        .category-btn {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .category-btn:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .category-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Professional Video Player Styles */
        .video-player-container {
            width: 100%;
            max-width: 1200px;
            background: #0f0f0f;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            aspect-ratio: 16/9;
            overflow: hidden;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .video-player-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            max-width: none;
            border-radius: 0;
            z-index: 9999;
        }

        .video-player-container.fullscreen .video-container {
            aspect-ratio: auto;
            height: 100%;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 25;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ff0000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: white;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: #ff0000;
            width: 0;
            transition: width 0.3s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .buffering-indicator {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            z-index: 5;
            display: none;
            animation: pulse 1.5s infinite;
        }

        .buffering-indicator.active {
            display: block;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }

        .video-container:hover .video-overlay,
        .video-container.paused .video-overlay {
            opacity: 1;
        }

        .play-pause-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 30px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }

        .play-pause-btn:hover,
        .play-pause-btn:focus {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.3);
            outline: none;
        }

        .player-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            padding: 20px 15px 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 10;
            pointer-events: none;
        }

        .player-controls > * {
            pointer-events: auto;
        }

        .video-container:hover .player-controls,
        .video-container.paused .player-controls {
            transform: translateY(0);
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            cursor: pointer;
        }

        .progress-bar {
            height: 100%;
            background: #ff0000;
            border-radius: 3px;
            width: 0;
        }

        .progress-handle {
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #ff0000;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .progress-container:hover .progress-handle {
            opacity: 1;
        }

        .control-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .left-controls,
        .right-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .control-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .control-btn:hover,
        .control-btn:focus {
            color: #ff0000;
            outline: none;
        }

        .time-display {
            font-size: 14px;
            color: #ddd;
            font-variant-numeric: tabular-nums;
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .volume-slider {
            width: 80px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            cursor: pointer;
        }

        .volume-level {
            height: 100%;
            background: white;
            border-radius: 2px;
            width: 100%;
        }

        .settings-menu,
        .more-menu,
        .loop-menu,
        .speed-menu,
        .aspect-menu {
            position: absolute;
            bottom: 60px;
            right: 15px;
            background: rgba(28, 28, 28, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 10px 0;
            min-width: 200px;
            max-width: 280px;
            display: none;
            flex-direction: column;
            z-index: 20;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            max-height: 70vh;
            overflow-y: auto;
        }

        .settings-menu.active,
        .more-menu.active,
        .loop-menu.active,
        .speed-menu.active,
        .aspect-menu.active {
            display: flex;
        }

        .settings-item,
        .menu-item {
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }

        .settings-item:hover,
        .menu-item:hover,
        .settings-item:focus,
        .menu-item:focus {
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }

        .settings-item i,
        .menu-item i {
            font-size: 16px;
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .menu-header {
            padding: 10px 20px;
            font-weight: bold;
            font-size: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 5px;
        }

        .menu-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 5px 0;
        }

        .submenu-item.active {
            color: #ff0000;
        }

        .submenu-item.active::after {
            content: "âœ“";
            font-weight: bold;
        }

        .speed-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            z-index: 5;
            display: none;
        }

        .speed-indicator.active {
            display: block;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            transition: background 0.3s;
            cursor: pointer;
        }

        .toggle-switch.active {
            background: #ff0000;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        .brightness-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            opacity: 0;
            pointer-events: none;
            z-index: 3;
            transition: opacity 0.1s;
        }

        .gesture-feedback {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 20px;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            z-index: 15;
        }

        .gesture-feedback.active {
            display: flex;
        }

        .gesture-icon {
            font-size: 32px;
            color: white;
        }

        .gesture-text {
            font-size: 16px;
            color: white;
            font-weight: 600;
        }

        .seek-feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 20px 30px;
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 15;
        }

        .seek-feedback.active {
            display: flex;
        }

        .seek-feedback i {
            font-size: 32px;
        }

        .lock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 30;
        }

        .lock-overlay.active {
            display: flex;
        }

        .lock-icon {
            font-size: 48px;
            color: white;
            animation: pulse 2s infinite;
        }

        .video-title {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
            z-index: 5;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 4px;
            max-width: 80%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .live-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ff0000;
            color: white;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            z-index: 5;
            display: none;
            align-items: center;
            gap: 6px;
        }

        .live-indicator.active {
            display: flex;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .record-btn {
            position: relative;
            display: none;
        }

        .record-btn.active {
            display: inline-block;
        }

        .record-btn.recording .fa-circle {
            color: #ff0000;
            animation: pulse 1.5s infinite;
        }

        .recording-indicator {
            position: absolute;
            top: 55px;
            right: 15px;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            z-index: 5;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .recording-indicator.active {
            display: flex;
        }

        .recording-time {
            font-variant-numeric: tabular-nums;
        }

        @media (max-width: 768px) {
            .volume-slider {
                width: 60px;
            }

            .settings-menu,
            .more-menu,
            .loop-menu,
            .speed-menu,
            .aspect-menu {
                min-width: 180px;
            }
        }

        @media (max-width: 480px) {
            .control-btn span {
                display: none;
            }

            .volume-slider {
                display: none;
            }

            .time-display {
                font-size: 12px;
            }

            .video-title {
                font-size: 14px;
                max-width: 70%;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="glass-effect sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <!-- Logo -->
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-white">live_tv</span>
                    </div>
                    <h1 class="text-2xl font-bold" style="font-family: 'Baloo 2', cursive;">
                        Live<span class="text-blue-400">TV</span>
                    </h1>
                </div>
                
                <!-- Navigation -->
                <div class="flex items-center space-x-4">
                    <!-- Search Button -->
                    <button id="searchBtn" class="p-2 rounded-lg hover:bg-white/10 transition">
                        <span class="material-symbols-outlined">search</span>
                    </button>
                    
                    <!-- Import M3U Button -->
                    <button id="importBtn" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg flex items-center space-x-2 transition">
                        <span class="material-symbols-outlined text-sm">file_upload</span>
                        <span>Import M3U</span>
                    </button>
                </div>
            </div>
            
            <!-- Search Bar -->
            <div id="searchContainer" class="hidden mt-3">
                <div class="relative">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Search channels..." 
                        class="w-full px-4 py-3 pl-12 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:border-blue-500 transition"
                    >
                    <span class="material-symbols-outlined absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">search</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 container mx-auto px-4 py-8">
        <!-- Hero Section -->
        <section class="text-center mb-12 fade-in">
            <h2 class="text-4xl md:text-5xl font-bold mb-4" style="font-family: 'Baloo 2', cursive;">
                Watch <span class="text-blue-400">Live TV</span> Anywhere
            </h2>
            <p class="text-gray-300 text-lg mb-8 max-w-2xl mx-auto">
                Stream your favorite TV channels in HD quality. Sports, news, entertainment, and more - all in one place.
            </p>
            
            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-2xl mx-auto mb-8">
                <div class="glass-effect p-6 rounded-xl text-center">
                    <div class="text-2xl font-bold text-blue-400 mb-2" id="totalChannels">0</div>
                    <div class="text-gray-300">Channels</div>
                </div>
                <div class="glass-effect p-6 rounded-xl text-center">
                    <div class="text-2xl font-bold text-green-400 mb-2" id="totalCategories">0</div>
                    <div class="text-gray-300">Categories</div>
                </div>
                <div class="glass-effect p-6 rounded-xl text-center">
                    <div class="text-2xl font-bold text-purple-400 mb-2" id="totalClicks">0</div>
                    <div class="text-gray-300">Total Views</div>
                </div>
            </div>
        </section>

        <!-- Categories -->
        <section class="mb-8 fade-in">
            <h3 class="text-2xl font-bold mb-6 flex items-center">
                <span class="material-symbols-outlined mr-3 text-blue-400">category</span>
                Categories
            </h3>
            <div id="categoryList" class="flex flex-wrap gap-3 mb-6">
                <!-- Categories will be loaded here -->
            </div>
        </section>

        <!-- Featured Channels -->
        <section class="mb-8 fade-in">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold flex items-center">
                    <span class="material-symbols-outlined mr-3 text-blue-400">star</span>
                    Featured Channels
                </h3>
                <div class="flex space-x-2">
                    <button class="sort-btn p-2 rounded-lg hover:bg-white/10 transition" data-sort="popular" title="Most Popular">
                        <span class="material-symbols-outlined">trending_up</span>
                    </button>
                    <button class="sort-btn p-2 rounded-lg hover:bg-white/10 transition" data-sort="recent" title="Recently Added">
                        <span class="material-symbols-outlined">schedule</span>
                    </button>
                </div>
            </div>
            <div id="featuredChannels" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <!-- Featured channels will be loaded here -->
            </div>
        </section>

        <!-- All Channels -->
        <section class="fade-in">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold flex items-center">
                    <span class="material-symbols-outlined mr-3 text-blue-400">tv</span>
                    All Channels
                </h3>
                <div class="flex items-center space-x-2">
                    <button id="viewToggle" class="p-2 rounded-lg hover:bg-white/10 transition" title="Toggle View">
                        <span class="material-symbols-outlined" id="viewIcon">grid_view</span>
                    </button>
                    <select id="categoryFilter" class="bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                        <option value="all">All Categories</option>
                    </select>
                </div>
            </div>
            <div id="channelGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <!-- Channels will be loaded here -->
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="glass-effect mt-12">
        <div class="container mx-auto px-4 py-8">
            <div class="text-center text-gray-400">
                <p>&copy; 2024 LiveTV. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Professional Player Modal -->
    <div id="playerModal" class="fixed inset-0 bg-black z-50 hidden flex items-center justify-center p-4">
        <div class="video-player-container" id="videoPlayerContainer">
            <div class="video-container" id="videoContainer">
                <video id="mainVideo" preload="metadata" aria-label="Video player">
                    Your browser does not support the video tag.
                </video>

                <div class="video-title" id="videoTitle">Channel Name</div>

                <div class="live-indicator" id="liveIndicator">
                    <div class="live-dot"></div>
                    <span>LIVE</span>
                </div>

                <div class="recording-indicator" id="recordingIndicator">
                    <i class="fas fa-circle" aria-hidden="true"></i>
                    <span>REC</span>
                    <span class="recording-time" id="recordingTime">00:00</span>
                </div>

                <div class="loading-overlay" id="loadingOverlay">
                    <div class="loading-spinner"></div>
                    <div class="loading-text" id="loadingText">Loading video...</div>
                    <div class="loading-progress">
                        <div class="loading-progress-bar" id="loadingProgressBar"></div>
                    </div>
                </div>

                <div class="buffering-indicator" id="bufferingIndicator">Buffering...</div>

                <div class="brightness-overlay" id="brightnessOverlay"></div>

                <div class="speed-indicator" id="speedIndicator">1.0x</div>

                <div class="lock-overlay" id="lockOverlay">
                    <i class="fas fa-lock lock-icon" aria-hidden="true"></i>
                </div>

                <div class="gesture-feedback" id="gestureFeedback">
                    <i class="fas fa-volume-up gesture-icon" id="gestureIcon" aria-hidden="true"></i>
                    <span class="gesture-text" id="gestureText">100%</span>
                </div>

                <div class="seek-feedback" id="seekFeedback">
                    <i class="fas fa-forward" id="seekIcon" aria-hidden="true"></i>
                    <span class="gesture-text" id="seekText">+10s</span>
                </div>

                <div class="video-overlay" id="videoOverlay">
                    <button class="play-pause-btn" id="overlayPlayPause" aria-label="Play or pause video">
                        <i class="fas fa-play" aria-hidden="true"></i>
                    </button>
                </div>

                <div class="player-controls">
                    <div class="progress-container" id="progressContainer" role="slider" aria-label="Video progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                        <div class="progress-bar" id="progressBar">
                            <div class="progress-handle"></div>
                        </div>
                    </div>

                    <div class="control-buttons">
                        <div class="left-controls">
                            <button class="control-btn" id="playPauseBtn" aria-label="Play or pause video">
                                <i class="fas fa-play" aria-hidden="true"></i>
                            </button>
                            <button class="control-btn" id="rewindBtn" aria-label="Rewind 10 seconds">
                                <i class="fas fa-backward-step" aria-hidden="true"></i>
                            </button>
                            <button class="control-btn" id="forwardBtn" aria-label="Forward 10 seconds">
                                <i class="fas fa-forward-step" aria-hidden="true"></i>
                            </button>

                            <div class="volume-container">
                                <button class="control-btn" id="volumeBtn" aria-label="Toggle mute">
                                    <i class="fas fa-volume-high" aria-hidden="true"></i>
                                </button>
                                <div class="volume-slider" id="volumeSlider" role="slider" aria-label="Volume control" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100">
                                    <div class="volume-level" id="volumeLevel"></div>
                                </div>
                            </div>

                            <div class="time-display" aria-live="polite">
                                <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
                            </div>
                        </div>

                        <div class="right-controls">
                            <button class="control-btn record-btn" id="recordBtn" aria-label="Record live stream" title="Record Stream">
                                <i class="fas fa-circle" aria-hidden="true"></i>
                            </button>
                            <button class="control-btn" id="lockBtn" aria-label="Lock controls">
                                <i class="fas fa-lock-open" aria-hidden="true"></i>
                            </button>
                            <button class="control-btn" id="speedBtn" aria-label="Open playback speed menu" aria-expanded="false">
                                <i class="fas fa-tachometer-alt" aria-hidden="true"></i>
                            </button>
                            <button class="control-btn" id="aspectBtn" aria-label="Open aspect ratio menu" aria-expanded="false">
                                <i class="fas fa-expand-arrows-alt" aria-hidden="true"></i>
                            </button>
                            <button class="control-btn" id="settingsBtn" aria-label="Open settings menu" aria-expanded="false">
                                <i class="fas fa-cog" aria-hidden="true"></i>
                            </button>
                            <button class="control-btn" id="subtitlesBtn" aria-label="Toggle subtitles">
                                <i class="fas fa-closed-captioning" aria-hidden="true"></i>
                            </button>
                            <button class="control-btn" id="loopBtn" aria-label="Open loop settings menu" aria-expanded="false">
                                <i class="fas fa-repeat" aria-hidden="true"></i>
                            </button>
                            <button class="control-btn" id="pipBtn" aria-label="Enter picture-in-picture mode">
                                <i class="fas fa-up-right-from-square" aria-hidden="true"></i>
                            </button>
                            <button class="control-btn" id="moreBtn" aria-label="Open more options menu" aria-expanded="false">
                                <i class="fas fa-ellipsis-v" aria-hidden="true"></i>
                            </button>
                            <button class="control-btn" id="fullscreenBtn" aria-label="Toggle fullscreen">
                                <i class="fas fa-expand" aria-hidden="true"></i>
                            </button>
                            <button class="control-btn" id="closePlayerBtn" aria-label="Close player">
                                <i class="fas fa-times" aria-hidden="true"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="speed-menu" id="speedMenu" role="menu" aria-label="Playback speed menu">
                    <div class="menu-header">Playback Speed</div>
                    <button class="menu-item" data-speed="0.25" role="menuitem"><span>0.25x</span></button>
                    <button class="menu-item" data-speed="0.5" role="menuitem"><span>0.5x</span></button>
                    <button class="menu-item" data-speed="0.75" role="menuitem"><span>0.75x</span></button>
                    <button class="menu-item submenu-item active" data-speed="1" role="menuitem"><span>Normal</span></button>
                    <button class="menu-item" data-speed="1.25" role="menuitem"><span>1.25x</span></button>
                    <button class="menu-item" data-speed="1.5" role="menuitem"><span>1.5x</span></button>
                    <button class="menu-item" data-speed="1.75" role="menuitem"><span>1.75x</span></button>
                    <button class="menu-item" data-speed="2" role="menuitem"><span>2.0x</span></button>
                </div>

                <div class="aspect-menu" id="aspectMenu" role="menu" aria-label="Aspect ratio menu">
                    <div class="menu-header">Aspect Ratio</div>
                    <button class="menu-item submenu-item active" data-ratio="contain" role="menuitem"><span>Fit Screen</span></button>
                    <button class="menu-item" data-ratio="cover" role="menuitem"><span>Fill Screen</span></button>
                    <button class="menu-item" data-ratio="fill" role="menuitem"><span>Stretch</span></button>
                    <div class="menu-divider"></div>
                    <button class="menu-item" data-ratio="16/9" role="menuitem"><span>16:9</span></button>
                    <button class="menu-item" data-ratio="4/3" role="menuitem"><span>4:3</span></button>
                    <button class="menu-item" data-ratio="21/9" role="menuitem"><span>21:9</span></button>
                    <button class="menu-item" data-ratio="1/1" role="menuitem"><span>1:1</span></button>
                </div>

                <div class="settings-menu" id="settingsMenu" role="menu" aria-label="Settings menu">
                    <div class="menu-header">Settings</div>
                    <button class="settings-item" id="qualityBtn" role="menuitem">
                        <div><i class="fas fa-hd" aria-hidden="true"></i><span>Quality</span></div>
                        <span id="currentQuality">Auto</span>
                    </button>
                    <button class="settings-item" id="audioBtn" role="menuitem">
                        <div><i class="fas fa-volume-up" aria-hidden="true"></i><span>Audio Track</span></div>
                        <span>Track 1</span>
                    </button>
                    <button class="settings-item" id="subtitleBtn" role="menuitem">
                        <div><i class="fas fa-closed-captioning" aria-hidden="true"></i><span>Subtitles</span></div>
                        <span>Off</span>
                    </button>
                    <div class="menu-divider"></div>
                    <button class="settings-item" id="gesturesBtn" role="menuitem">
                        <div><i class="fas fa-hand-pointer" aria-hidden="true"></i><span>Gesture Controls</span></div>
                        <div class="toggle-switch active" id="gesturesToggle" aria-label="Toggle gesture controls"></div>
                    </button>
                    <button class="settings-item" id="nightModeBtn" role="menuitem">
                        <div><i class="fas fa-moon" aria-hidden="true"></i><span>Night Mode</span></div>
                        <div class="toggle-switch" id="nightModeToggle" aria-label="Toggle night mode"></div>
                    </button>
                    <button class="settings-item" id="mirrorBtn" role="menuitem">
                        <div><i class="fas fa-arrows-alt-h" aria-hidden="true"></i><span>Mirror Mode</span></div>
                        <div class="toggle-switch" id="mirrorToggle" aria-label="Toggle mirror mode"></div>
                    </button>
                    <button class="settings-item" id="volumeBoostBtn" role="menuitem">
                        <div><i class="fas fa-volume-up" aria-hidden="true"></i><span>Audio Boost (200%)</span></div>
                        <div class="toggle-switch" id="volumeBoostToggle" aria-label="Toggle audio boost"></div>
                    </button>
                    <div class="menu-divider"></div>
                    <button class="settings-item" id="equalizerBtn" role="menuitem">
                        <div><i class="fas fa-sliders-h" aria-hidden="true"></i><span>Equalizer</span></div>
                    </button>
                    <button class="settings-item" id="castBtn" role="menuitem">
                        <div><i class="fas fa-wifi" aria-hidden="true"></i><span>Cast</span></div>
                    </button>
                    <button class="settings-item" id="timerBtn" role="menuitem">
                        <div><i class="fas fa-clock" aria-hidden="true"></i><span>Sleep Timer</span></div>
                        <span>Off</span>
                    </button>
                </div>

                <div class="more-menu" id="moreMenu" role="menu" aria-label="More options menu">
                    <div class="menu-header">More Options</div>
                    <button class="menu-item" id="cutBtn" role="menuitem">
                        <div><i class="fas fa-cut" aria-hidden="true"></i><span>Cut</span></div>
                    </button>
                    <button class="menu-item" id="favoriteBtn" role="menuitem">
                        <div><i class="fas fa-heart" aria-hidden="true"></i><span>Favorite</span></div>
                    </button>
                    <button class="menu-item" id="bookmarkBtn" role="menuitem">
                        <div><i class="fas fa-bookmark" aria-hidden="true"></i><span>Bookmark</span></div>
                    </button>
                    <button class="menu-item" id="vrBtn" role="menuitem">
                        <div><i class="fas fa-vr-cardboard" aria-hidden="true"></i><span>VR Mode</span></div>
                    </button>
                    <div class="menu-divider"></div>
                    <button class="menu-item" id="shareBtn" role="menuitem">
                        <div><i class="fas fa-share-alt" aria-hidden="true"></i><span>Share</span></div>
                    </button>
                    <button class="menu-item" id="fileInfoBtn" role="menuitem">
                        <div><i class="fas fa-file-alt" aria-hidden="true"></i><span>File Info</span></div>
                    </button>
                    <button class="menu-item" id="tutorialBtn" role="menuitem">
                        <div><i class="fas fa-graduation-cap" aria-hidden="true"></i><span>Tutorials</span></div>
                    </button>
                </div>

                <div class="loop-menu" id="loopMenu" role="menu" aria-label="Loop settings menu">
                    <div class="menu-header">Loop Settings</div>
                    <button class="menu-item submenu-item active" id="loopOffBtn" role="menuitem">
                        <div><i class="fas fa-times-circle" aria-hidden="true"></i><span>Loop Off</span></div>
                    </button>
                    <button class="menu-item" id="loopOneBtn" role="menuitem">
                        <div><i class="fas fa-redo" aria-hidden="true"></i><span>Loop Current</span></div>
                    </button>
                    <div class="menu-divider"></div>
                    <button class="menu-item" id="abRepeatBtn" role="menuitem">
                        <div><i class="fas fa-exchange-alt" aria-hidden="true"></i><span>AB Repeat</span></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-effect rounded-xl p-6 max-w-md w-full">
            <h3 class="text-xl font-bold mb-4 flex items-center">
                <span class="material-symbols-outlined mr-2 text-blue-400">file_upload</span>
                Import M3U Playlist
            </h3>
            
            <!-- URL Input -->
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">M3U URL</label>
                <input type="url" id="m3uUrl" placeholder="https://example.com/playlist.m3u" 
                       class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500">
            </div>
            
            <div class="text-center text-gray-400 my-4">OR</div>
            
            <!-- File Upload -->
            <div class="mb-6">
                <label class="block text-sm font-medium mb-2">Upload M3U File</label>
                <input type="file" id="m3uFile" accept=".m3u,.m3u8" 
                       class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
            </div>
            
            <div class="flex space-x-3">
                <button id="importCancel" class="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition">
                    Cancel
                </button>
                <button id="importConfirm" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition flex items-center justify-center">
                    <span class="material-symbols-outlined text-sm mr-2">upload</span>
                    Import
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-white">Loading channels...</p>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB9GaCbYFH22WbiLs1pc_UJTsM_0Tetj6E",
            authDomain: "tnm3ulive.firebaseapp.com",
            databaseURL: "https://tnm3ulive-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tnm3ulive",
            storageBucket: "tnm3ulive.firebasestorage.app",
            messagingSenderId: "80664356882",
            appId: "1:80664356882:web:c8464819b0515ec9b210cb",
            measurementId: "G-FNS9JWZ9LS"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref("channels");

        // Global Variables
        let allChannels = [];
        let currentView = "grid";
        let currentCategory = "all";
        let hls = null;
        let currentChannel = null;

        // DOM Elements
        const elements = {
            // Main app elements
            loadingSpinner: document.getElementById('loadingSpinner'),
            searchContainer: document.getElementById('searchContainer'),
            searchInput: document.getElementById('searchInput'),
            searchBtn: document.getElementById('searchBtn'),
            categoryList: document.getElementById('categoryList'),
            featuredChannels: document.getElementById('featuredChannels'),
            channelGrid: document.getElementById('channelGrid'),
            categoryFilter: document.getElementById('categoryFilter'),
            viewToggle: document.getElementById('viewToggle'),
            viewIcon: document.getElementById('viewIcon'),
            importBtn: document.getElementById('importBtn'),
            importModal: document.getElementById('importModal'),
            importCancel: document.getElementById('importCancel'),
            importConfirm: document.getElementById('importConfirm'),
            m3uUrl: document.getElementById('m3uUrl'),
            m3uFile: document.getElementById('m3uFile'),
            totalChannels: document.getElementById('totalChannels'),
            totalCategories: document.getElementById('totalCategories'),
            totalClicks: document.getElementById('totalClicks'),

            // Player elements
            playerModal: document.getElementById('playerModal'),
            videoPlayerContainer: document.getElementById('videoPlayerContainer'),
            videoContainer: document.getElementById('videoContainer'),
            mainVideo: document.getElementById('mainVideo'),
            videoTitle: document.getElementById('videoTitle'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingText: document.getElementById('loadingText'),
            loadingProgressBar: document.getElementById('loadingProgressBar'),
            bufferingIndicator: document.getElementById('bufferingIndicator'),
            brightnessOverlay: document.getElementById('brightnessOverlay'),
            speedIndicator: document.getElementById('speedIndicator'),
            lockOverlay: document.getElementById('lockOverlay'),
            gestureFeedback: document.getElementById('gestureFeedback'),
            gestureIcon: document.getElementById('gestureIcon'),
            gestureText: document.getElementById('gestureText'),
            seekFeedback: document.getElementById('seekFeedback'),
            seekIcon: document.getElementById('seekIcon'),
            seekText: document.getElementById('seekText'),
            videoOverlay: document.getElementById('videoOverlay'),
            overlayPlayPause: document.getElementById('overlayPlayPause'),
            progressContainer: document.getElementById('progressContainer'),
            progressBar: document.getElementById('progressBar'),
            currentTime: document.getElementById('currentTime'),
            duration: document.getElementById('duration'),
            playPauseBtn: document.getElementById('playPauseBtn'),
            rewindBtn: document.getElementById('rewindBtn'),
            forwardBtn: document.getElementById('forwardBtn'),
            volumeBtn: document.getElementById('volumeBtn'),
            volumeSlider: document.getElementById('volumeSlider'),
            volumeLevel: document.getElementById('volumeLevel'),
            recordBtn: document.getElementById('recordBtn'),
            liveIndicator: document.getElementById('liveIndicator'),
            recordingIndicator: document.getElementById('recordingIndicator'),
            recordingTime: document.getElementById('recordingTime'),
            lockBtn: document.getElementById('lockBtn'),
            speedBtn: document.getElementById('speedBtn'),
            aspectBtn: document.getElementById('aspectBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            subtitlesBtn: document.getElementById('subtitlesBtn'),
            loopBtn: document.getElementById('loopBtn'),
            pipBtn: document.getElementById('pipBtn'),
            moreBtn: document.getElementById('moreBtn'),
            fullscreenBtn: document.getElementById('fullscreenBtn'),
            closePlayerBtn: document.getElementById('closePlayerBtn'),
            speedMenu: document.getElementById('speedMenu'),
            aspectMenu: document.getElementById('aspectMenu'),
            settingsMenu: document.getElementById('settingsMenu'),
            moreMenu: document.getElementById('moreMenu'),
            loopMenu: document.getElementById('loopMenu'),
            currentQuality: document.getElementById('currentQuality'),
            gesturesToggle: document.getElementById('gesturesToggle'),
            nightModeToggle: document.getElementById('nightModeToggle'),
            mirrorToggle: document.getElementById('mirrorToggle'),
            volumeBoostToggle: document.getElementById('volumeBoostToggle')
        };

        // Player State
        let playerState = {
            isPlaying: false,
            isMuted: false,
            volume: 1,
            playbackRate: 1,
            isFullscreen: false,
            isLocked: false,
            isSpeedMenuOpen: false,
            isAspectMenuOpen: false,
            isSettingsOpen: false,
            isMoreMenuOpen: false,
            isLoopMenuOpen: false,
            currentAspectRatio: 'contain',
            brightness: 100,
            nightMode: false,
            mirrorMode: false,
            volumeBoost: false,
            gesturesEnabled: true,
            loopMode: 'off',
            abRepeat: { start: null, end: null },
            autoFullscreen: false,
            isLiveStream: false,
            isRecording: false,
            recordingStartTime: 0,
            mediaRecorder: null,
            recordedChunks: []
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initEventListeners();
            loadChannels();
            initPlayer();
        });

        function initEventListeners() {
            // Search functionality
            elements.searchBtn.addEventListener('click', toggleSearch);
            elements.searchInput.addEventListener('input', filterChannels);

            // View toggle
            elements.viewToggle.addEventListener('click', toggleView);

            // Category filter
            elements.categoryFilter.addEventListener('change', function() {
                currentCategory = this.value;
                renderChannels();
            });

            // Import functionality
            elements.importBtn.addEventListener('click', () => elements.importModal.classList.remove('hidden'));
            elements.importCancel.addEventListener('click', () => elements.importModal.classList.add('hidden'));
            elements.importConfirm.addEventListener('click', importM3U);

            // Close modals with ESC key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePlayer();
                    elements.importModal.classList.add('hidden');
                }
            });
        }

        function initPlayer() {
            // Player event listeners
            elements.playPauseBtn.addEventListener('click', togglePlayPause);
            elements.overlayPlayPause.addEventListener('click', togglePlayPause);
            elements.videoOverlay.addEventListener('click', togglePlayPause);
            
            elements.rewindBtn.addEventListener('click', () => {
                elements.mainVideo.currentTime -= 10;
                showSeekFeedback(-10);
            });

            elements.forwardBtn.addEventListener('click', () => {
                elements.mainVideo.currentTime += 10;
                showSeekFeedback(10);
            });

            elements.volumeBtn.addEventListener('click', toggleMute);
            elements.fullscreenBtn.addEventListener('click', toggleFullscreen);
            elements.closePlayerBtn.addEventListener('click', closePlayer);
            elements.lockBtn.addEventListener('click', toggleLockScreen);
            
            elements.progressContainer.addEventListener('click', seekVideo);
            
            // Video event listeners
            elements.mainVideo.addEventListener('loadedmetadata', updateTimeDisplay);
            elements.mainVideo.addEventListener('timeupdate', updateProgress);
            elements.mainVideo.addEventListener('waiting', showLoading);
            elements.mainVideo.addEventListener('playing', hideLoading);
            elements.mainVideo.addEventListener('error', showError);
            elements.mainVideo.addEventListener('canplay', hideLoading);
            
            // Volume control
            elements.volumeSlider.addEventListener('click', (e) => {
                const rect = elements.volumeSlider.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                playerState.volume = Math.max(0, Math.min(1, percent));
                elements.mainVideo.volume = playerState.volumeBoost ? Math.min(1, playerState.volume * 2) : playerState.volume;
                elements.volumeLevel.style.width = `${playerState.volume * 100}%`;
                
                if (playerState.volume === 0) {
                    elements.volumeBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                    playerState.isMuted = true;
                    elements.mainVideo.muted = true;
                } else {
                    elements.volumeBtn.innerHTML = '<i class="fas fa-volume-high"></i>';
                    playerState.isMuted = false;
                    elements.mainVideo.muted = false;
                }
                
                showGestureFeedback('volume', playerState.volume);
            });

            // Menu buttons
            elements.speedBtn.addEventListener('click', toggleSpeedMenu);
            elements.aspectBtn.addEventListener('click', toggleAspectMenu);
            elements.settingsBtn.addEventListener('click', toggleSettingsMenu);
            elements.moreBtn.addEventListener('click', toggleMoreMenu);
            elements.loopBtn.addEventListener('click', toggleLoopMenu);

            // Close menus when clicking outside
            document.addEventListener('click', (e) => {
                if (!elements.speedMenu.contains(e.target) && e.target !== elements.speedBtn) {
                    elements.speedMenu.classList.remove('active');
                    playerState.isSpeedMenuOpen = false;
                }
                
                if (!elements.aspectMenu.contains(e.target) && e.target !== elements.aspectBtn) {
                    elements.aspectMenu.classList.remove('active');
                    playerState.isAspectMenuOpen = false;
                }
                
                if (!elements.settingsMenu.contains(e.target) && e.target !== elements.settingsBtn) {
                    elements.settingsMenu.classList.remove('active');
                    playerState.isSettingsOpen = false;
                }
                
                if (!elements.moreMenu.contains(e.target) && e.target !== elements.moreBtn) {
                    elements.moreMenu.classList.remove('active');
                    playerState.isMoreMenuOpen = false;
                }
                
                if (!elements.loopMenu.contains(e.target) && e.target !== elements.loopBtn) {
                    elements.loopMenu.classList.remove('active');
                    playerState.isLoopMenuOpen = false;
                }
            });

            // Speed menu items
            document.querySelectorAll('#speedMenu .menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    const speed = parseFloat(item.dataset.speed);
                    changePlaybackSpeed(speed);
                    elements.speedMenu.classList.remove('active');
                    playerState.isSpeedMenuOpen = false;
                });
            });

            // Aspect menu items
            document.querySelectorAll('#aspectMenu .menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    const ratio = item.dataset.ratio;
                    changeAspectRatio(ratio);
                    elements.aspectMenu.classList.remove('active');
                    playerState.isAspectMenuOpen = false;
                });
            });

            // Settings menu items
            document.getElementById('nightModeBtn').addEventListener('click', toggleNightMode);
            document.getElementById('mirrorBtn').addEventListener('click', toggleMirrorMode);
            document.getElementById('volumeBoostBtn').addEventListener('click', toggleVolumeBoost);
            document.getElementById('gesturesBtn').addEventListener('click', toggleGestures);

            // Loop menu items
            document.getElementById('loopOffBtn').addEventListener('click', () => changeLoopMode('off'));
            document.getElementById('loopOneBtn').addEventListener('click', () => changeLoopMode('one'));

            // Record button
            elements.recordBtn.addEventListener('click', toggleRecording);

            // Initialize player
            elements.volumeLevel.style.width = '100%';
            changePlaybackSpeed(1);
            changeAspectRatio('contain');
            changeLoopMode('off');
        }

        function toggleSearch() {
            elements.searchContainer.classList.toggle('hidden');
            if (!elements.searchContainer.classList.contains('hidden')) {
                elements.searchInput.focus();
            }
        }

        function toggleView() {
            currentView = currentView === "grid" ? "list" : "grid";
            elements.viewIcon.textContent = currentView === "grid" ? "grid_view" : "view_list";
            renderChannels();
        }

        function loadChannels() {
            elements.loadingSpinner.classList.remove('hidden');
            
            dbRef.on('value', (snapshot) => {
                allChannels = [];
                let totalClicks = 0;
                
                snapshot.forEach((snap) => {
                    const channel = snap.val();
                    channel.id = snap.key;
                    if (!channel.clicks) channel.clicks = 0;
                    if (!channel.createdAt) channel.createdAt = new Date().toISOString();
                    
                    allChannels.push(channel);
                    totalClicks += channel.clicks;
                });

                updateStats(allChannels.length, new Set(allChannels.map(ch => ch.category)).size, totalClicks);
                renderCategories();
                renderFeaturedChannels();
                renderChannels();
                elements.loadingSpinner.classList.add('hidden');
            });
        }

        function updateStats(channels, categories, clicks) {
            elements.totalChannels.textContent = channels;
            elements.totalCategories.textContent = categories;
            elements.totalClicks.textContent = clicks;
        }

        function renderCategories() {
            const categories = [...new Set(allChannels.map(ch => ch.category))];
            elements.categoryList.innerHTML = '';
            elements.categoryFilter.innerHTML = '<option value="all">All Categories</option>';

            categories.forEach(category => {
                const count = allChannels.filter(ch => ch.category === category).length;
                
                // Category buttons
                const btn = document.createElement('button');
                btn.className = 'category-btn glass-effect px-4 py-3 rounded-lg flex items-center space-x-2';
                btn.innerHTML = `
                    <span class="material-symbols-outlined text-blue-400">live_tv</span>
                    <span>${category}</span>
                    <span class="bg-white/10 px-2 py-1 rounded text-sm">${count}</span>
                `;
                btn.addEventListener('click', () => filterByCategory(category));
                elements.categoryList.appendChild(btn);

                // Category filter options
                const option = document.createElement('option');
                option.value = category;
                option.textContent = `${category} (${count})`;
                elements.categoryFilter.appendChild(option);
            });
        }

        function renderFeaturedChannels() {
            const featured = [...allChannels]
                .sort((a, b) => b.clicks - a.clicks)
                .slice(0, 6);

            elements.featuredChannels.innerHTML = '';
            featured.forEach(channel => {
                elements.featuredChannels.appendChild(createChannelCard(channel));
            });
        }

        function renderChannels() {
            let filtered = [...allChannels];
            
            // Apply category filter
            if (currentCategory !== 'all') {
                filtered = filtered.filter(ch => ch.category === currentCategory);
            }
            
            // Apply search filter
            const searchTerm = elements.searchInput.value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(ch => 
                    ch.name.toLowerCase().includes(searchTerm) ||
                    (ch.category && ch.category.toLowerCase().includes(searchTerm))
                );
            }

            // Apply view
            elements.channelGrid.className = currentView === "grid" 
                ? "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"
                : "flex flex-col gap-3";

            elements.channelGrid.innerHTML = '';
            filtered.forEach(channel => {
                elements.channelGrid.appendChild(createChannelCard(channel));
            });
        }

        function createChannelCard(channel) {
            const card = document.createElement('div');
            card.className = `channel-card glass-effect rounded-xl p-4 cursor-pointer ${
                currentView === "list" ? "flex items-center space-x-4" : "text-center"
            }`;
            
            card.innerHTML = currentView === "grid" ? `
                <div class="w-16 h-16 mx-auto mb-3 bg-white/10 rounded-lg flex items-center justify-center">
                    <img src="${channel.icon || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIGZpbGw9IiMzMzMiLz48dGV4dCB4PSIzMiIgeT0iMzIiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+VFZfPC90ZXh0Pjwvc3ZnPg=='}" 
                         alt="${channel.name}" 
                         class="w-full h-full object-cover rounded-lg"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIGZpbGw9IiMzMzMiLz48dGV4dCB4PSIzMiIgeT0iMzIiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+VFZfPC90ZXh0Pjwvc3ZnPg=='">
                </div>
                <h4 class="font-semibold text-sm mb-1 truncate" style="font-family: 'Baloo 2', cursive;">${channel.name}</h4>
                <div class="text-xs text-gray-400 flex items-center justify-center space-x-1">
                    <span class="material-symbols-outlined text-xs">visibility</span>
                    <span>${channel.clicks || 0}</span>
                </div>
            ` : `
                <div class="w-12 h-12 bg-white/10 rounded-lg flex items-center justify-center flex-shrink-0">
                    <img src="${channel.icon || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIGZpbGw9IiMzMzMiLz48dGV4dCB4PSIyNCIgeT0iMjQiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+VFZfPC90ZXh0Pjwvc3ZnPg=='}" 
                         alt="${channel.name}" 
                         class="w-full h-full object-cover rounded-lg"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIGZpbGw9IiMzMzMiLz48dGV4dCB4PSIyNCIgeT0iMjQiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+VFZfPC90ZXh0Pjwvc3ZnPg=='">
                </div>
                <div class="flex-1 min-w-0">
                    <h4 class="font-semibold truncate" style="font-family: 'Baloo 2', cursive;">${channel.name}</h4>
                    <p class="text-sm text-gray-400 truncate">${channel.category || 'Uncategorized'}</p>
                </div>
                <div class="text-sm text-gray-400 flex items-center space-x-1">
                    <span class="material-symbols-outlined text-sm">visibility</span>
                    <span>${channel.clicks || 0}</span>
                </div>
            `;

            card.addEventListener('click', () => playChannel(channel));
            return card;
        }

        function filterByCategory(category) {
            currentCategory = category;
            elements.categoryFilter.value = category;
            renderChannels();
            
            // Scroll to channels section
            document.querySelector('#channelGrid').scrollIntoView({ behavior: 'smooth' });
        }

        function filterChannels() {
            renderChannels();
        }

        function playChannel(channel) {
            currentChannel = channel;
            
            // Update click count
            dbRef.child(channel.id).child('clicks').transaction(val => (val || 0) + 1);
            
            // Show player and loading
            elements.playerModal.classList.remove('hidden');
            showLoading();
            hideError();
            
            // Update video title
            elements.videoTitle.textContent = channel.name;
            
            // Clean up previous HLS instance
            if (hls) {
                hls.destroy();
                hls = null;
            }
            
            // Reset video
            elements.mainVideo.pause();
            elements.mainVideo.removeAttribute('src');
            elements.mainVideo.load();
            
            const streamUrl = channel.stream;
            
            // Check if it's a live stream
            updateLiveStreamStatus(streamUrl);
            
            // Check if it's an HLS stream
            if (Hls.isSupported() && streamUrl.includes('.m3u8')) {
                hls = new Hls({
                    enableWorker: false,
                    lowLatencyMode: true,
                    backBufferLength: 90
                });
                
                hls.loadSource(streamUrl);
                hls.attachMedia(elements.mainVideo);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    elements.mainVideo.play().catch(e => {
                        console.log('Autoplay prevented:', e);
                    });
                });
                
                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error('HLS Error:', data);
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                hls.recoverMediaError();
                                break;
                            default:
                                showError();
                                break;
                        }
                    }
                });
                
            } else {
                // Regular video stream
                elements.mainVideo.src = streamUrl;
                elements.mainVideo.play().catch(e => {
                    console.log('Autoplay prevented:', e);
                });
            }
        }

        // Player control functions
        function togglePlayPause() {
            if (playerState.isPlaying) {
                elements.mainVideo.pause();
                elements.videoContainer.classList.add('paused');
            } else {
                elements.mainVideo.play();
                elements.videoContainer.classList.remove('paused');
            }
            playerState.isPlaying = !playerState.isPlaying;
            
            // Update play/pause button
            const icon = playerState.isPlaying ? 'fa-pause' : 'fa-play';
            elements.playPauseBtn.innerHTML = `<i class="fas ${icon}"></i>`;
            elements.overlayPlayPause.innerHTML = `<i class="fas ${icon}"></i>`;
        }

        function toggleMute() {
            playerState.isMuted = !playerState.isMuted;
            elements.mainVideo.muted = playerState.isMuted;
            
            if (playerState.isMuted) {
                elements.volumeBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                elements.volumeLevel.style.width = '0%';
            } else {
                elements.volumeBtn.innerHTML = '<i class="fas fa-volume-high"></i>';
                elements.volumeLevel.style.width = `${playerState.volume * 100}%`;
            }
        }

        function toggleFullscreen() {
            if (!playerState.isFullscreen) {
                if (elements.videoPlayerContainer.requestFullscreen) {
                    elements.videoPlayerContainer.requestFullscreen();
                } else if (elements.videoPlayerContainer.webkitRequestFullscreen) {
                    elements.videoPlayerContainer.webkitRequestFullscreen();
                } else if (elements.videoPlayerContainer.msRequestFullscreen) {
                    elements.videoPlayerContainer.msRequestFullscreen();
                }
                playerState.isFullscreen = true;
                elements.videoPlayerContainer.classList.add('fullscreen');
                elements.fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                playerState.isFullscreen = false;
                elements.videoPlayerContainer.classList.remove('fullscreen');
                elements.fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            }
        }

        function toggleLockScreen() {
            playerState.isLocked = !playerState.isLocked;
            
            if (playerState.isLocked) {
                elements.lockBtn.innerHTML = '<i class="fas fa-lock"></i>';
                elements.lockOverlay.classList.add('active');
                // Hide all controls when locked
                elements.videoOverlay.style.opacity = '0';
                document.querySelector('.player-controls').style.transform = 'translateY(100%)';
                closeAllMenus();
            } else {
                elements.lockBtn.innerHTML = '<i class="fas fa-lock-open"></i>';
                elements.lockOverlay.classList.remove('active');
            }
        }

        function seekVideo(e) {
            const rect = elements.progressContainer.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            elements.mainVideo.currentTime = percent * elements.mainVideo.duration;
        }

        function updateProgress() {
            const value = (elements.mainVideo.currentTime / elements.mainVideo.duration) * 100;
            elements.progressBar.style.width = value + '%';
            updateTimeDisplay();
        }

        function updateTimeDisplay() {
            elements.currentTime.textContent = formatTime(elements.mainVideo.currentTime);
            elements.duration.textContent = formatTime(elements.mainVideo.duration);
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '00:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function showLoading() {
            elements.loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            elements.loadingOverlay.classList.add('hidden');
        }

        function showError() {
            elements.bufferingIndicator.classList.add('active');
            elements.loadingOverlay.classList.add('hidden');
        }

        function hideError() {
            elements.bufferingIndicator.classList.remove('active');
        }

        function closeAllMenus() {
            elements.speedMenu.classList.remove('active');
            elements.aspectMenu.classList.remove('active');
            elements.settingsMenu.classList.remove('active');
            elements.moreMenu.classList.remove('active');
            elements.loopMenu.classList.remove('active');
            
            playerState.isSpeedMenuOpen = false;
            playerState.isAspectMenuOpen = false;
            playerState.isSettingsOpen = false;
            playerState.isMoreMenuOpen = false;
            playerState.isLoopMenuOpen = false;
        }

        function toggleSpeedMenu() {
            playerState.isSpeedMenuOpen = !playerState.isSpeedMenuOpen;
            elements.speedMenu.classList.toggle('active', playerState.isSpeedMenuOpen);
            
            // Close other menus
            closeOtherMenus('speed');
        }

        function toggleAspectMenu() {
            playerState.isAspectMenuOpen = !playerState.isAspectMenuOpen;
            elements.aspectMenu.classList.toggle('active', playerState.isAspectMenuOpen);
            
            // Close other menus
            closeOtherMenus('aspect');
        }

        function toggleSettingsMenu() {
            playerState.isSettingsOpen = !playerState.isSettingsOpen;
            elements.settingsMenu.classList.toggle('active', playerState.isSettingsOpen);
            
            // Close other menus
            closeOtherMenus('settings');
        }

        function toggleMoreMenu() {
            playerState.isMoreMenuOpen = !playerState.isMoreMenuOpen;
            elements.moreMenu.classList.toggle('active', playerState.isMoreMenuOpen);
            
            // Close other menus
            closeOtherMenus('more');
        }

        function toggleLoopMenu() {
            playerState.isLoopMenuOpen = !playerState.isLoopMenuOpen;
            elements.loopMenu.classList.toggle('active', playerState.isLoopMenuOpen);
            
            // Close other menus
            closeOtherMenus('loop');
        }

        function closeOtherMenus(except) {
            if (except !== 'speed') {
                elements.speedMenu.classList.remove('active');
                playerState.isSpeedMenuOpen = false;
            }
            if (except !== 'aspect') {
                elements.aspectMenu.classList.remove('active');
                playerState.isAspectMenuOpen = false;
            }
            if (except !== 'settings') {
                elements.settingsMenu.classList.remove('active');
                playerState.isSettingsOpen = false;
            }
            if (except !== 'more') {
                elements.moreMenu.classList.remove('active');
                playerState.isMoreMenuOpen = false;
            }
            if (except !== 'loop') {
                elements.loopMenu.classList.remove('active');
                playerState.isLoopMenuOpen = false;
            }
        }

        function changePlaybackSpeed(speed) {
            elements.mainVideo.playbackRate = speed;
            playerState.playbackRate = speed;
            
            // Update display
            elements.speedIndicator.textContent = `${speed}x`;
            elements.speedIndicator.classList.add('active');
            
            // Update active item in menu
            document.querySelectorAll('#speedMenu .menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`#speedMenu .menu-item[data-speed="${speed}"]`).classList.add('active');
            
            // Hide indicator after 2 seconds
            setTimeout(() => {
                elements.speedIndicator.classList.remove('active');
            }, 2000);
        }

        function changeAspectRatio(ratio) {
            elements.mainVideo.style.objectFit = ratio;
            playerState.currentAspectRatio = ratio;
            
            // Update active item in menu
            document.querySelectorAll('#aspectMenu .menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`#aspectMenu .menu-item[data-ratio="${ratio}"]`).classList.add('active');
        }

        function toggleNightMode() {
            playerState.nightMode = !playerState.nightMode;
            elements.nightModeToggle.classList.toggle('active', playerState.nightMode);
            
            if (playerState.nightMode) {
                // Apply night mode filter
                elements.mainVideo.style.filter = 'sepia(0.3) brightness(0.7)';
            } else {
                // Remove night mode filter
                elements.mainVideo.style.filter = 'none';
            }
        }

        function toggleMirrorMode() {
            playerState.mirrorMode = !playerState.mirrorMode;
            elements.mirrorToggle.classList.toggle('active', playerState.mirrorMode);
            
            if (playerState.mirrorMode) {
                elements.mainVideo.style.transform = 'scaleX(-1)';
            } else {
                elements.mainVideo.style.transform = 'scaleX(1)';
            }
        }

        function toggleVolumeBoost() {
            playerState.volumeBoost = !playerState.volumeBoost;
            elements.volumeBoostToggle.classList.toggle('active', playerState.volumeBoost);
            
            if (playerState.volumeBoost) {
                elements.mainVideo.volume = Math.min(1, playerState.volume * 2);
            } else {
                elements.mainVideo.volume = playerState.volume;
            }
        }

        function toggleGestures() {
            playerState.gesturesEnabled = !playerState.gesturesEnabled;
            elements.gesturesToggle.classList.toggle('active', playerState.gesturesEnabled);
        }

        function changeLoopMode(mode) {
            playerState.loopMode = mode;
            
            // Update active item in menu
            document.querySelectorAll('#loopMenu .menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`loop${mode.charAt(0).toUpperCase() + mode.slice(1)}Btn`).classList.add('active');
            
            switch(mode) {
                case 'off':
                    elements.mainVideo.loop = false;
                    elements.loopBtn.style.color = 'white';
                    break;
                case 'one':
                    elements.mainVideo.loop = true;
                    elements.loopBtn.style.color = '#ff0000';
                    break;
                case 'all':
                    // This would typically loop a playlist
                    elements.loopBtn.style.color = '#ff0000';
                    break;
            }
        }

        function showGestureFeedback(type, value) {
            if (!playerState.gesturesEnabled) return;
            
            elements.gestureFeedback.classList.add('active');
            
            if (type === 'volume') {
                elements.gestureIcon.className = 'fas fa-volume-up gesture-icon';
                elements.gestureText.textContent = `${Math.round(value * 100)}%`;
            } else if (type === 'brightness') {
                elements.gestureIcon.className = 'fas fa-sun gesture-icon';
                elements.gestureText.textContent = `${Math.round(value)}%`;
            }
            
            // Hide after 1.5 seconds
            setTimeout(() => {
                elements.gestureFeedback.classList.remove('active');
            }, 1500);
        }

        function showSeekFeedback(seconds) {
            elements.seekFeedback.classList.add('active');
            
            if (seconds > 0) {
                elements.seekIcon.className = 'fas fa-forward';
                elements.seekText.textContent = `+${seconds}s`;
            } else {
                elements.seekIcon.className = 'fas fa-backward';
                elements.seekText.textContent = `${seconds}s`;
            }
            
            // Hide after 1.5 seconds
            setTimeout(() => {
                elements.seekFeedback.classList.remove('active');
            }, 1500);
        }

        // Detect if source is a live stream
        function updateLiveStreamStatus(src) {
            if (!src) return false;
            
            // Check for common live stream patterns
            const livePatterns = [
                /\.m3u8/i,           // HLS streams
                /\.mpd/i,            // DASH streams
                /\/live\//i,         // Common live path
                /livestream/i,       // Livestream in URL
                /live\..*\.(com|net|tv)/i, // Live domains
                /rtmp:\/\//i,        // RTMP protocol
                /rtsp:\/\//i,        // RTSP protocol
                /\/playlist\.m3u8/i, // HLS playlist
                /\/manifest\.mpd/i   // DASH manifest
            ];
            
            playerState.isLiveStream = livePatterns.some(pattern => pattern.test(src));
            
            if (playerState.isLiveStream) {
                elements.liveIndicator.classList.add('active');
                elements.recordBtn.classList.add('active');
                
                // Hide rewind/forward for live streams
                elements.rewindBtn.style.display = 'none';
                elements.forwardBtn.style.display = 'none';
            } else {
                elements.liveIndicator.classList.remove('active');
                elements.recordBtn.classList.remove('active');
                
                // Show rewind/forward for regular videos
                elements.rewindBtn.style.display = 'inline-block';
                elements.forwardBtn.style.display = 'inline-block';
            }
        }

        // Toggle recording
        function toggleRecording() {
            if (!playerState.isLiveStream) return;
            
            if (!playerState.isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        // Start recording
        function startRecording() {
            try {
                // Create a stream from the video element
                const stream = elements.mainVideo.captureStream ? elements.mainVideo.captureStream() : elements.mainVideo.mozCaptureStream();
                
                if (!stream) {
                    alert('Recording is not supported in your browser');
                    return;
                }
                
                // Set up MediaRecorder
                const options = { mimeType: 'video/webm;codecs=vp9' };
                
                // Fallback to vp8 if vp9 is not supported
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm;codecs=vp8';
                }
                
                // Fallback to default if webm is not supported
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm';
                }
                
                playerState.mediaRecorder = new MediaRecorder(stream, options);
                playerState.recordedChunks = [];
                
                playerState.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        playerState.recordedChunks.push(event.data);
                    }
                };
                
                playerState.mediaRecorder.onstop = () => {
                    // Create a blob from recorded chunks
                    const blob = new Blob(playerState.recordedChunks, { type: 'video/webm' });
                    
                    // Create download link
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `recording_${new Date().getTime()}.webm`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Cleanup
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    playerState.recordedChunks = [];
                };
                
                // Start recording
                playerState.mediaRecorder.start(1000); // Collect data every second
                playerState.isRecording = true;
                playerState.recordingStartTime = Date.now();
                
                // Update UI
                elements.recordBtn.classList.add('recording');
                elements.recordingIndicator.classList.add('active');
                
                // Update recording time display
                updateRecordingTime();
                
            } catch (error) {
                console.error('Recording error:', error);
                alert('Failed to start recording: ' + error.message);
            }
        }

        // Stop recording
        function stopRecording() {
            if (playerState.mediaRecorder && playerState.isRecording) {
                playerState.mediaRecorder.stop();
                playerState.isRecording = false;
                
                // Update UI
                elements.recordBtn.classList.remove('recording');
                elements.recordingIndicator.classList.remove('active');
            }
        }

        // Update recording time
        function updateRecordingTime() {
            if (!playerState.isRecording) return;
            
            const elapsed = Math.floor((Date.now() - playerState.recordingStartTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            elements.recordingTime.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            requestAnimationFrame(updateRecordingTime);
        }

        function closePlayer() {
            if (hls) {
                hls.destroy();
                hls = null;
            }
            elements.mainVideo.pause();
            elements.mainVideo.removeAttribute('src');
            elements.mainVideo.load();
            elements.playerModal.classList.add('hidden');
            hideError();
            hideLoading();
            
            // Stop recording if active
            if (playerState.isRecording) {
                stopRecording();
            }
        }

        // M3U Import Functions
        async function importM3U() {
            const url = elements.m3uUrl.value.trim();
            const file = elements.m3uFile.files[0];
            
            if (!url && !file) {
                alert('Please provide either a URL or select a file.');
                return;
            }
            
            try {
                elements.importConfirm.disabled = true;
                elements.importConfirm.innerHTML = '<span class="material-symbols-outlined animate-spin text-sm mr-2">refresh</span>Importing...';
                
                let m3uContent;
                
                if (url) {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Failed to fetch M3U file');
                    m3uContent = await response.text();
                } else {
                    m3uContent = await readFileAsText(file);
                }
                
                const channels = parseM3U(m3uContent);
                
                // Add channels to Firebase
                for (const channel of channels) {
                    await dbRef.child(channel.id).set(channel);
                }
                
                alert(`Successfully imported ${channels.length} channels!`);
                elements.importModal.classList.add('hidden');
                resetImportForm();
                
            } catch (error) {
                console.error('Import error:', error);
                alert('Failed to import M3U: ' + error.message);
            } finally {
                elements.importConfirm.disabled = false;
                elements.importConfirm.innerHTML = '<span class="material-symbols-outlined text-sm mr-2">upload</span>Import';
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function parseM3U(content) {
            const lines = content.split('\n');
            const channels = [];
            let currentChannel = {};
            
            for (const line of lines) {
                const trimmed = line.trim();
                
                if (trimmed.startsWith('#EXTINF:')) {
                    currentChannel = parseExtinf(trimmed);
                } else if (trimmed.startsWith('http')) {
                    if (currentChannel.name) {
                        currentChannel.stream = trimmed;
                        currentChannel.id = 'ch_' + Math.random().toString(36).substr(2, 9);
                        currentChannel.clicks = 0;
                        currentChannel.createdAt = new Date().toISOString();
                        
                        channels.push({...currentChannel});
                        currentChannel = {};
                    }
                }
            }
            
            return channels;
        }

        function parseExtinf(line) {
            const channel = {};
            
            // Extract name
            const nameMatch = line.match(/,(.*)$/);
            if (nameMatch) channel.name = nameMatch[1].trim();
            
            // Extract logo
            const logoMatch = line.match(/tvg-logo="([^"]*)"/);
            channel.icon = logoMatch ? logoMatch[1] : '';
            
            // Extract group (category)
            const groupMatch = line.match(/group-title="([^"]*)"/);
            channel.category = groupMatch ? groupMatch[1] : 'Imported';
            
            return channel;
        }

        function resetImportForm() {
            elements.m3uUrl.value = '';
            elements.m3uFile.value = '';
        }
    </script>
</body>
</html>
