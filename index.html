l                }
                localStorage.setItem('eagleRoyalFavorites', JSON.stringify(state.favorites));
                updateChannelCards();
                updateStats();
            }

            function updateChannelCards() {
                document.querySelectorAll('.channel-card').forEach(card => {
                    const channelName = card.dataset.name;
                    card.classList.toggle('favorite', state.favorites.some(fav => fav.name === channelName));
                });
            }

            // Menu Toggle
            document.getElementById('menuToggle').addEventListener('click', () => {
                elements.sideMenu.classList.add('open');
            });

            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (elements.sideMenu.classList.contains('open') && 
                    !elements.sideMenu.contains(e.target) && 
                    !document.getElementById('menuToggle').contains(e.target)) {
                    elements.sideMenu.classList.remove('open');
                }
            });

            // Menu Items
            document.getElementById('menuHome').addEventListener('click', () => {
                elements.sideMenu.classList.remove('open');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                showNotification('üè† Welcome Home');
            });

            document.getElementById('menuSearch').addEventListener('click', () => {
                elements.sideMenu.classList.remove('open');
                elements.searchInput.focus();
                showNotification('üîç Search channels');
            });

            document.getElementById('menuLiveTV').addEventListener('click', () => {
                elements.sideMenu.classList.remove('open');
                state.selectedCategory = 'All';
                state.selectedGenre = 'All';
                state.selectedLanguage = 'all';
                applyFiltersAndRender();
                showNotification('üì∫ Showing all channels');
            });

            document.getElementById('menuFavorite').addEventListener('click', () => {
                elements.sideMenu.classList.remove('open');
                if (state.favorites.length === 0) return showNotification('‚ö†Ô∏è No favorites yet');
                state.currentlyVisibleChannels = state.favorites;
                renderChannels();
                showNotification('‚ù§Ô∏è Showing favorites');
            });

            document.getElementById('menuContact').addEventListener('click', () => {
                elements.sideMenu.classList.remove('open');
                window.open('https://t.me/EAGLEROYALM3u8', '_blank');
                showNotification('üìß Opening Telegram');
            });

            document.getElementById('menuPrivacy').addEventListener('click', () => {
                elements.sideMenu.classList.remove('open');
                showNotification('üîí Privacy: We do not collect personal data');
            });

            document.getElementById('menuSettings').addEventListener('click', () => {
                elements.sideMenu.classList.remove('open');
                showNotification('‚öôÔ∏è Settings panel coming soon!');
            });

            document.getElementById('menuHistory').addEventListener('click', () => {
                elements.sideMenu.classList.remove('open');
                if (state.watchHistory.length === 0) return showNotification('‚è∞ No watch history yet');
                showNotification(`‚è∞ Showing ${state.watchHistory.length} history items`);
            });

            // Header Icons
            document.getElementById('favoriteIcon').addEventListener('click', () => {
                if (state.favorites.length === 0) return showNotification('‚ö†Ô∏è No favorites yet');
                state.currentlyVisibleChannels = state.favorites;
                renderChannels();
                showNotification('‚ù§Ô∏è Showing favorites');
            });

            document.getElementById('settingsIcon').addEventListener('click', () => {
                showNotification('‚öôÔ∏è Settings panel coming soon!');
            });

            document.getElementById('historyIcon').addEventListener('click', () => {
                if (state.watchHistory.length === 0) return showNotification('‚è∞ No watch history yet');
                showNotification(`‚è∞ Showing ${state.watchHistory.length} history items`);
            });

            // Theme Switching
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const theme = btn.dataset.theme;
                    document.body.className = `${theme}-mode`;
                    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    showNotification(`üé® ${theme} theme activated`);
                });
            });

            // Playlist Switching
            document.querySelectorAll('.playlist-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.currentPlaylist = btn.dataset.playlist;
                    document.querySelectorAll('.playlist-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    showNotification(`üì° Loading ${btn.textContent}...`);
                    fetchAndPrepareChannels();
                });
            });

            // Genre Filter
            document.querySelectorAll('.genre-tag').forEach(tag => {
                tag.addEventListener('click', () => {
                    state.selectedGenre = tag.dataset.genre;
                    document.querySelectorAll('.genre-tag').forEach(t => t.classList.remove('active'));
                    tag.classList.add('active');
                    applyFiltersAndRender();
                    showNotification(`üé¨ Filter: ${state.selectedGenre}`);
                });
            });

            // Language Filter
            document.querySelectorAll('.language-card').forEach(card => {
                card.addEventListener('click', () => {
                    state.selectedLanguage = card.dataset.lang;
                    document.querySelectorAll('.language-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    applyFiltersAndRender();
                    showNotification(`üåê Language: ${state.selectedLanguage}`);
                });
            });

            // Toggle Filters
            document.getElementById('genreToggle').addEventListener('click', function() {
                const genreTags = document.getElementById('genreTags');
                if (genreTags.style.display === 'none') {
                    genreTags.style.display = 'flex';
                    this.textContent = 'Hide Genres';
                } else {
                    genreTags.style.display = 'none';
                    this.textContent = 'Show Genres';
                }
            });

            document.getElementById('langToggle').addEventListener('click', function() {
                const langGrid = document.getElementById('languageGrid');
                if (langGrid.style.display === 'none') {
                    langGrid.style.display = 'grid';
                    this.textContent = 'Hide Languages';
                } else {
                    langGrid.style.display = 'none';
                    this.textContent = 'Show Languages';
                }
            });

            document.getElementById('categoryToggle').addEventListener('click', function() {
                if (elements.categoryFilters.style.display === 'none') {
                    elements.categoryFilters.style.display = 'flex';
                    this.textContent = 'Hide Filters';
                } else {
                    elements.categoryFilters.style.display = 'none';
                    this.textContent = 'Show Filters';
                }
            });
            
            // View Mode Toggle
            viewModes.forEach(mode => {
                document.getElementById(`${mode}ViewBtn`).addEventListener('click', function() {
                    state.viewMode = mode;
                    localStorage.setItem('eagleRoyalViewMode', mode);
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    renderChannels();
                    showNotification(`üëÅÔ∏è ${mode.charAt(0).toUpperCase() + mode.slice(1)} View`);
                });
            });

            // FAB Actions
            document.getElementById('topFab').addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            document.getElementById('randomFab').addEventListener('click', () => {
                if (state.currentlyVisibleChannels.length === 0) return;
                const randomChannel = state.currentlyVisibleChannels[Math.floor(Math.random() * state.currentlyVisibleChannels.length)];
                const card = document.querySelector(`.channel-card[data-name="${randomChannel.name}"]`);
                if (card) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    showNotification(`üé≤ Random: ${randomChannel.name}`);
                }
            });

            document.getElementById('refreshFab').addEventListener('click', () => {
                fetchAndPrepareChannels();
            });

            document.getElementById('multiViewFab').addEventListener('click', () => {
                showNotification('üîÑ Multi-View mode activated');
            });

            // Search
            let searchTimeout;
            elements.searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    state.currentSearchTerm = this.value.trim();
                    applyFiltersAndRender();
                }, 300);
            });

            // Fetch and Parse Channels
            function parseM3uData(data) {
                const channels = [];
                const lines = data.split('\n');
                let currentChannel = {};

                for (const line of lines) {
                    const trimmed = line.trim();
                    if (trimmed.startsWith('#EXTINF')) {
                        const match = /#EXTINF:-1\s+(.*),(.*)/.exec(trimmed);
                        if (match) {
                            const logoMatch = /tvg-logo="([^"]*)"/.exec(match[1]);
                            const groupMatch = /group-title="([^"]*)"/.exec(match[1]);
                            currentChannel = {
                                name: match[2].trim(),
                                icon: logoMatch ? logoMatch[1] : 'https://placehold.co/120x60/1a3a5f/e0f0ff?text=Logo',
                                category: groupMatch ? groupMatch[1] : 'General',
                                playlist: state.currentPlaylist
                            };
                        }
                    } else if (trimmed.startsWith('http') && currentChannel.name) {
                        currentChannel.url = trimmed;
                        channels.push(currentChannel);
                        currentChannel = {};
                    }
                }
                return channels;
            }

            async function fetchAndPrepareChannels() {
                try {
                    elements.loadingSpinner.style.display = 'flex';
                    elements.messageContainer.textContent = 'üöÄ Loading channels...';
                    elements.messageContainer.style.display = 'block';
                    
                    const response = await fetch(`${CORS_PROXY_URL}${PLAYLISTS[state.currentPlaylist]}`);
                    if (!response.ok) throw new Error(`Server error: ${response.status}`);
                    
                    const data = await response.text();
                    state.allChannels = parseM3uData(data);
                    
                    if (state.allChannels.length === 0) {
                        elements.messageContainer.textContent = '‚ö†Ô∏è No channels found';
                    } else {
                        elements.messageContainer.style.display = 'none';
                        displayCategories();
                        applyFiltersAndRender();
                        updateStats();
                        showNotification(`‚úÖ Loaded ${state.allChannels.length} channels`);
                    }
                } catch (error) {
                    elements.messageContainer.textContent = `‚ùå Error: ${error.message}`;
                } finally {
                    elements.loadingSpinner.style.display = 'none';
                }
            }

            function displayCategories() {
                const categories = ['All', ...new Set(state.allChannels.map(ch => ch.category).sort())];
                elements.categoryFilters.innerHTML = categories.map(cat => 
                    `<button class="category-btn ${cat === 'All' ? 'active' : ''}" data-category="${cat}">${cat}</button>`
                ).join('');

                elements.categoryFilters.addEventListener('click', (e) => {
                    if (e.target.classList.contains('category-btn')) {
                        state.selectedCategory = e.target.dataset.category;
                        document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        applyFiltersAndRender();
                    }
                });
            }

            function applyFiltersAndRender() {
                let filtered = state.allChannels;
                
                if (state.selectedCategory !== 'All') {
                    filtered = filtered.filter(ch => ch.category === state.selectedCategory);
                }
                
                if (state.selectedGenre !== 'All') {
                    filtered = filtered.filter(ch => ch.category.includes(state.selectedGenre));
                }
                
                if (state.selectedLanguage !== 'all') {
                    filtered = filtered.filter(ch => ch.category.includes(state.selectedLanguage));
                }
                
                if (state.currentSearchTerm) {
                    filtered = filtered.filter(ch => ch.name.toLowerCase().includes(state.currentSearchTerm.toLowerCase()));
                }
                
                state.currentlyVisibleChannels = filtered;
                renderChannels();
                updateStats();
            }

            function renderChannels() {
                elements.channelGrid.innerHTML = '';
                
                if (state.currentlyVisibleChannels.length === 0) {
                    elements.messageContainer.textContent = 'üîç No channels found';
                    elements.messageContainer.style.display = 'block';
                    return;
                }
                
                elements.messageContainer.style.display = 'none';
                
                // Change container class based on view mode
                elements.channelGrid.className = `channels-${state.viewMode}`;

                state.currentlyVisibleChannels.forEach(channel => {
                    const isFavorite = state.favorites.some(fav => fav.name === channel.name);
                    
                    if (state.viewMode === 'list') {
                        // List View
                        const listItem = document.createElement('div');
                        listItem.className = 'channel-list-item';
                        listItem.dataset.stream = btoa(channel.url);
                        listItem.dataset.name = channel.name;
                        listItem.dataset.icon = channel.icon;
                        listItem.innerHTML = `
                            <div class="list-item-image">
                                <img src="${channel.icon}" alt="${channel.name}" loading="lazy" onerror="this.src='https://placehold.co/120x60/1a3a5f/e0f0ff?text=Logo';">
                                <div class="list-item-quality">HD</div>
                            </div>
                            <div class="list-item-content">
                                <div class="list-item-name">${channel.name}</div>
                                <div class="list-item-category">
                                    <i class="fas fa-tag"></i> ${channel.category}
                                </div>
                            </div>
                            <div class="list-item-actions">
                                <div class="list-action-btn list-favorite-btn ${isFavorite ? 'active' : ''}" data-action="favorite">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="list-action-btn" data-action="play">
                                    <i class="fas fa-play"></i>
                                </div>
                            </div>
                        `;
                        
                        listItem.addEventListener('click', (e) => {
                            const action = e.target.closest('[data-action]')?.dataset.action;
                            if (action === 'favorite') {
                                e.stopPropagation();
                                toggleFavorite(channel);
                                return;
                            }
                            if (action === 'play' || !action) {
                                handleChannelClick(e);
                            }
                        });
                        
                        elements.channelGrid.appendChild(listItem);
                    } else if (state.viewMode === 'compact') {
                        // Compact View
                        const card = document.createElement('div');
                        card.className = `channel-compact-card ${isFavorite ? 'favorite' : ''}`;
                        card.dataset.stream = btoa(channel.url);
                        card.dataset.name = channel.name;
                        card.dataset.icon = channel.icon;
                        card.innerHTML = `
                            <div class="compact-image">
                                <img src="${channel.icon}" alt="${channel.name}" loading="lazy" onerror="this.src='https://placehold.co/120x60/1a3a5f/e0f0ff?text=Logo';">
                            </div>
                            <div class="compact-name">${channel.name}</div>
                            <div style="position:absolute;top:10px;right:10px;color:gold;font-size:20px;opacity:${isFavorite?1:0}">
                                <i class="fas fa-heart"></i>
                            </div>
                        `;
                        
                        card.addEventListener('click', (e) => {
                            handleChannelClick(e);
                        });
                        
                        card.addEventListener('dblclick', () => toggleFavorite(channel));
                        
                        elements.channelGrid.appendChild(card);
                    } else if (state.viewMode === 'masonry') {
                        // Masonry View
                        const card = document.createElement('div');
                        card.className = `channel-masonry-card ${isFavorite ? 'favorite' : ''}`;
                        card.dataset.stream = btoa(channel.url);
                        card.dataset.name = channel.name;
                        card.dataset.icon = channel.icon;
                        card.innerHTML = `
                            <div class="masonry-image">
                                <img src="${channel.icon}" alt="${channel.name}" loading="lazy" onerror="this.src='https://placehold.co/120x60/1a3a5f/e0f0ff?text=Logo';">
                            </div>
                            <div class="masonry-info">
                                <div class="masonry-name">${channel.name}</div>
                                <div class="masonry-category">${channel.category}</div>
                            </div>
                        `;
                        
                        card.addEventListener('click', (e) => {
                            handleChannelClick(e);
                        });
                        
                        card.addEventListener('dblclick', () => toggleFavorite(channel));
                        
                        elements.channelGrid.appendChild(card);
                    } else if (state.viewMode === 'details') {
                        // Details View
                        const card = document.createElement('div');
                        card.className = `channel-details-card ${isFavorite ? 'favorite' : ''}`;
                        card.dataset.stream = btoa(channel.url);
                        card.dataset.name = channel.name;
                        card.dataset.icon = channel.icon;
                        card.innerHTML = `
                            <div class="details-image-wrapper">
                                <img src="${channel.icon}" alt="${channel.name}" loading="lazy" onerror="this.src='https://placehold.co/120x60/1a3a5f/e0f0ff?text=Logo';">
                            </div>
                            <div class="details-content">
                                <div class="details-name">${channel.name}</div>
                                <div class="details-meta">
                                    <div class="details-badge">${channel.category}</div>
                                    <div class="details-badge">HD</div>
                                    <div class="details-badge">Live</div>
                                </div>
                                <div class="details-description">
                                    Watch ${channel.name} live stream in high quality. Available in multiple languages with premium features.
                                </div>
                                <div class="details-actions">
                                    <button class="details-action-btn details-favorite-btn ${isFavorite ? 'active' : ''}" data-action="favorite">
                                        <i class="fas fa-heart"></i> ${isFavorite ? 'Favorited' : 'Favorite'}
                                    </button>
                                    <button class="details-action-btn" data-action="play">
                                        <i class="fas fa-play"></i> Play Now
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        card.addEventListener('click', (e) => {
                            const action = e.target.closest('[data-action]')?.dataset.action;
                            if (action === 'favorite') {
                                e.stopPropagation();
                                toggleFavorite(channel);
                                return;
                            }
                            if (action === 'play' || !action) {
                                handleChannelClick(e);
                            }
                        });
                        
                        elements.channelGrid.appendChild(card);
                    } else if (state.viewMode === 'minimal') {
                        // Minimal View
                        const card = document.createElement('div');
                        card.className = `channel-minimal-card ${isFavorite ? 'favorite' : ''}`;
                        card.dataset.stream = btoa(channel.url);
                        card.dataset.name = channel.name;
                        card.dataset.icon = channel.icon;
                        card.innerHTML = `
                            <div class="minimal-image">
                                <img src="${channel.icon}" alt="${channel.name}" loading="lazy" onerror="this.src='https://placehold.co/120x60/1a3a5f/e0f0ff?text=Logo';">
                            </div>
                            <div class="minimal-name">${channel.name}</div>
                        `;
                        
                        card.addEventListener('click', (e) => {
                            handleChannelClick(e);
                        });
                        
                        card.addEventListener('dblclick', () => toggleFavorite(channel));
                        
                        elements.channelGrid.appendChild(card);
                    } else if (state.viewMode === 'carousel') {
                        // Carousel View
                        const card = document.createElement('div');
                        card.className = `channel-carousel-card ${isFavorite ? 'favorite' : ''}`;
                        card.dataset.stream = btoa(channel.url);
                        card.dataset.name = channel.name;
                        card.dataset.icon = channel.icon;
                        card.innerHTML = `
                            <div class="carousel-image">
                                <img src="${channel.icon}" alt="${channel.name}" loading="lazy" onerror="this.src='https://placehold.co/120x60/1a3a5f/e0f0ff?text=Logo';">
                            </div>
                            <div class="carousel-name">${channel.name}</div>
                        `;
                        
                        card.addEventListener('click', (e) => {
                            handleChannelClick(e);
                        });
                        
                        card.addEventListener('dblclick', () => toggleFavorite(channel));
                        
                        elements.channelGrid.appendChild(card);
                    } else {
                        // Grid View (default)
                        const card = document.createElement('div');
                        card.className = `channel-card ${isFavorite ? 'favorite' : ''}`;
                        card.dataset.stream = btoa(channel.url);
                        card.dataset.name = channel.name;
                        card.dataset.icon = channel.icon;
                        card.innerHTML = `
                            <div class="channel-image">
                                <img src="${channel.icon}" alt="${channel.name}" loading="lazy" onerror="this.src='https://placehold.co/120x60/1a3a5f/e0f0ff?text=Logo';">
                                <div class="channel-quality">HD</div>
                            </div>
                            <div class="channel-info">
                                <h3 class="channel-name" title="${channel.name}">${channel.name}</h3>
                                <div class="channel-category"><i class="fas fa-tag"></i> ${channel.category}</div>
                            </div>
                            <div class="play-btn">‚ñ∂Ô∏è Play Now</div>
                            <div class="favorite-indicator"><i class="fas fa-star"></i></div>
                        `;
                        
                        card.addEventListener('click', (e) => {
                            if (e.target.closest('.favorite-indicator')) {
                                toggleFavorite(channel);
                                return;
                            }
                            handleChannelClick(e);
                        });
                        
                        card.addEventListener('dblclick', () => toggleFavorite(channel));
                        
                        elements.channelGrid.appendChild(card);
                    }
                });
            }

            function handleChannelClick(e) {
                e.preventDefault();
                const item = e.currentTarget;
                const streamUrl = item.dataset.stream;
                const channelName = item.dataset.name;
                const channelIcon = item.dataset.icon;
                
                const channel = {
                    name: channelName,
                    url: atob(streamUrl),
                    icon: channelIcon,
                    category: 'General'
                };
                addToRecentlyViewed(channel);
                
                document.getElementById('ogPlayerLink').href = `player.html?s=${encodeURIComponent(streamUrl)}&name=${encodeURIComponent(channelName)}`;
                document.getElementById('simplePlayerLink').href = `simple-player.html?s=${encodeURIComponent(streamUrl)}&name=${encodeURIComponent(channelName)}`;
                document.getElementById('advancedPlayerLink').href = `advanced-player.html?s=${encodeURIComponent(streamUrl)}&name=${encodeURIComponent(channelName)}`;
                document.getElementById('multiPlayerLink').href = `multi-player.html?s=${encodeURIComponent(streamUrl)}&name=${encodeURIComponent(channelName)}`;
                
                elements.modal.style.display = 'flex';
            }

            document.getElementById('modalClose').addEventListener('click', () => {
                elements.modal.style.display = 'none';
            });

            window.addEventListener('click', (e) => {
                if (e.target === elements.modal) elements.modal.style.display = 'none';
            });

            // Initialize
            updateRecentlyViewed();
            updateStats();
            fetchAndPrepareChannels();
            
            setTimeout(() => {
                showNotification('ü¶Ö Welcome to EAGLE ROYAL!', 5000);
            }, 1000);
        });
    </script>
</body>
</html>
